const $searchMask=document.getElementById("search-mask"),$searchDialog=document.querySelector("#local-search .search-dialog"),$input=document.querySelector("#search-input"),$resultContent=document.getElementById("search-results"),$loadingStatus=document.getElementById("loading-status");let dataObj=null;class search{static openSearch(){utils.fadeIn($searchMask,"0.5"),utils.fadeIn($searchDialog,"0.5"),setTimeout((()=>{document.querySelector("#search-input").focus()}),100),search.search(),document.addEventListener("keydown",(function e(t){"Escape"===t.code&&(closeSearch(),document.removeEventListener("keydown",e))}))}static closeSearch(){utils.fadeOut($searchDialog,"0.5"),utils.fadeOut($searchMask,"0.5")}static async fetchData(e){let t=[];const a=await fetch(e);if(t=[...(await(new window.DOMParser).parseFromString(await a.text(),"text/xml")).querySelectorAll("entry")].map((e=>({title:e.querySelector("title").textContent,content:e.querySelector("content")&&e.querySelector("content").textContent,url:e.querySelector("url").textContent}))),a.ok){const e=document.getElementById("loading-database");e.nextElementSibling.style.display="block",e.remove()}return t}static search(){GLOBALCONFIG.localsearch.preload||null!==dataObj||(dataObj=this.fetchData(GLOBALCONFIG.localsearch.path)),$input.addEventListener("input",(function(){const e=this.value.trim().toLowerCase().split(/[\s]+/);if(""===e[0])return void($resultContent.innerHTML="");if($loadingStatus.innerHTML='<i class="fas fa-spinner fa-pulse"></i><span>加载中</span>',e.length<=0)return;let t=0,a='<div class="search-result-list">';dataObj.then((c=>{c.forEach((c=>{let s=!0,r=c.title?c.title.trim().toLowerCase():"";const n=c.content?c.content.trim().replace(/<[^>]+>/g,"").toLowerCase():"",l=c.url.startsWith("/")?c.url:GLOBALCONFIG.root+c.url;let o=-1,i=-1,h=-1;if(""!==r||""!==n?e.forEach(((e,t)=>{o=r.indexOf(e),i=n.indexOf(e),o<0&&i<0?s=!1:(i<0&&(i=0),0===t&&(h=i))})):s=!1,s){if(h>=0){let c=h-30,s=h+100,o="",i="";c<0&&(c=0),0===c?s=100:o="...",s>n.length?s=n.length:i="...";let d=n.substring(c,s);e.forEach((e=>{const t=new RegExp(`(?!<[^>]*?)(${e})(?![^<]*?>)`,"gi");d=d.replaceAll(t,'<span class="search-keyword">$1</span>'),r=r.replaceAll(t,'<span class="search-keyword">$1</span>')})),a+='<div class="search__hit-item"><a href="'+l+'"><span class="search-result-title">'+r+"</span>",t+=1,""!==n&&(a+='<div class="search-result">'+o+d+i+"</div>")}a+="</a></div>"}})),a+=0===t?`<div id="search__hits-empty">${GLOBALCONFIG.lang.search.empty}</div>`:`<div class="search__hits-count">${GLOBALCONFIG.lang.search.hit.replace("${query}",'<span class="search-keyword">'+t+"</span>")}</div>`,a+="</div>",$resultContent.innerHTML=a,""!==e[0]&&($loadingStatus.innerHTML="")}))}))}}const searchClickFn=()=>{document.querySelector("#search-button > .search").addEventListener("click",search.openSearch)},searchClickFnOnce=()=>{document.querySelector("#local-search .search-close-button").addEventListener("click",search.closeSearch),$searchMask.addEventListener("click",search.closeSearch),GLOBALCONFIG.localsearch.preload&&(dataObj=search.fetchData(GLOBALCONFIG.localsearch.path))};window.addEventListener("load",(()=>{searchClickFn(),document.querySelector("#local-search .search-close-button").addEventListener("click",search.closeSearch),$searchMask.addEventListener("click",search.closeSearch),GLOBALCONFIG.localsearch.preload&&(dataObj=search.fetchData(GLOBALCONFIG.localsearch.path))})),window.addEventListener("pjax:complete",(()=>{searchClickFn()}));